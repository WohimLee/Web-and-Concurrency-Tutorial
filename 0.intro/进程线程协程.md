
## Process, Thread and Coroutine

### 一、家族关系图（总览）

```
操作系统
 └── 进程 Process（资源单位）
     ├── 子进程
     │
     └── 线程 Thread（执行单位）
         ├── 子线程
         │
         └── 协程 Coroutine（用户态调度）
```

一句话先记住：

> **进程管资源，线程跑代码，协程省切换**

---

### 二、进程 & 子进程

#### 1️⃣ 进程（Process）

>是什么

* 操作系统进行**资源分配**的最小单位
* 拥有**独立的地址空间**

>典型资源

* 虚拟内存空间
* 文件描述符
* 信号
* 进程 ID（PID）

>特点

* 进程之间**内存完全隔离**
* 切换成本高（用户态 ↔ 内核态）



#### 2️⃣ 子进程（Child Process）

>关系

* 由父进程创建（`fork()` / `CreateProcess()`）
* **逻辑上继承**父进程
* **物理内存不共享**

>内存

* 通常使用 **写时复制（Copy-On-Write）**
* 一开始看似共享，写时才真正复制

>通信（IPC）

* 管道（pipe）
* 共享内存
* 消息队列
* 信号
* socket

📌 **重点**

> 父子进程 ≠ 内存共享，只是“复制得很聪明”



### 三、线程 & 子线程

#### 1️⃣ 线程（Thread）

>是什么

* CPU 调度的基本单位
* **依附于进程存在**

>线程共享

* 进程的地址空间
* 堆
* 全局变量
* 文件描述符

>线程私有

* 栈（stack）
* 寄存器
* 线程 ID


#### 2️⃣ 子线程（本质就是线程）

严格说：**“子线程”不是操作系统概念**

只是语义上：

* 某个线程创建了另一个线程
* 本质还是同一进程内的普通线程

**内存**: 完全共享进程内存

**通信**

* 直接读写共享变量
* 需要同步手段：

  * mutex
  * spinlock
  * condition variable
  * atomic

📌 **重点**

> 线程通信最快，但也最容易写出 bug（数据竞争）


### 四、协程（Coroutine）

#### 1️⃣ 协程是什么

**一句话**

> 协程是“用户态的轻量线程”

**关键特征**

* 不由操作系统调度
* 由**程序自己调度**
* 切换不进内核

常见实现：

* Go 的 goroutine
* Python `async/await`




#### 2️⃣ 协程和线程的关系

```
进程
 └── 线程
     └── 多个协程
```

**内存**

* 协程共享所在**线程的全部内存**
* 协程有自己的：

  * 协程栈（通常很小，可伸缩）

**切换**

* 函数级别切换
* 不涉及系统调用
* 极快（纳秒级）


#### 3️⃣ 协程通信

方式取决于语言：

* 共享变量（同线程下通常无锁）
* Channel（Go）
* Promise / Future
* Event Loop

📌 **重要理解**

> 同一线程内的协程**不会并行执行**，只会并发执行



### 五、核心对比表（超重要）

| 维度       | 进程   | 线程       | 协程             |
| -------- | ---- | -------- | -------------- |
| 调度者      | 操作系统 | 操作系统     | 用户程序           |
| 是否独立地址空间 | ✅    | ❌        | ❌              |
| 切换成本     | 高    | 中        | 极低             |
| 内存共享     | ❌    | ✅（进程内）   | ✅（线程内）         |
| 是否并行     | ✅    | ✅        | ❌（单线程内）        |
| 通信方式     | IPC  | 共享内存 + 锁 | Channel / 共享变量 |
| 崩溃影响     | 仅自身  | 整个进程     | 整个线程           |


### 六、一句话总结（面试 / 复习版）

* **进程**：资源隔离单位，安全但重
* **线程**：执行单位，快但要小心同步
* **协程**：用户态并发，极轻，适合 I/O 密集

👉 **常见组合**

* 多进程 + 少线程：稳定
* 少进程 + 多线程：高性能
* 少线程 + 海量协程：高并发 I/O


### 七、比喻：公司模型

> **操作系统 = 国家**
> **进程 = 公司**
> **线程 = 员工**
> **协程 = 员工脑子里的待办清单**


#### 关系图（公司版）

```
工商局（操作系统）
 └── 公司 A（进程）
     ├── 分公司 A'（子进程）
     │
     ├── 员工 张三（线程）
     │    ├── 待办事项 1（协程）
     │    ├── 待办事项 2（协程）
     │    └── 待办事项 3（协程）
     │
     └── 员工 李四（线程）
          ├── 待办事项 4（协程）
          └── 待办事项 5（协程）
```

#### 对应关系

* **进程 = 公司**

  * 有自己办公室、资产、账户
  * 公司之间**不能随便进对方办公楼**（内存隔离）

* **子进程 = 分公司**

  * 成立时拷贝总部资源（COW）
  * 之后各干各的

* **线程 = 员工**

  * 共用公司的办公区、文件柜（共享内存）
  * 每个人有**自己的脑子**（线程栈）

* **协程 = 员工脑子里的事**

  * 同一时间只能想一件事
  * 但可以**随时切换注意力**
  * 切换几乎没成本
