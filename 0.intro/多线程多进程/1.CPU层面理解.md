## CPU 层面理解

### 1 CPU 层面的核心差别

##### 进程（Process）

- 由操作系统调度，分配独立内存和资源
- CPU 执行进程时，需要进行 `上下文切换（保存寄存器、页表等）`
- 多个进程在单核 CPU 上只能轮流运行；在多核 CPU 上可以并行运行

##### 线程（Thread）

- 属于进程的一部分，和同进程的其他线程共享内存资源
- 操作系统调度单位之一，切换比进程轻，但依然由内核完成
- 单核 CPU：多个线程轮流执行；多核 CPU：线程可被分配到不同核心，实现真正的并行

##### 协程（Coroutine）

- 运行在用户态，由程序控制切换（非内核）
- CPU 仍然只看到“一个线程”在跑，只不过这个线程内部自己切换协程
- 本质上在单核时是并发而非并行，除非多个线程/进程分别跑协程，才可能利用多核

### 2 图示
>单核 CPU
- 假设 CPU 有一个核心
    ```diff
    时间轴 →
    +-----------------------------+
    | P1 | P2 | P3 | P1 | P2 | P3 |   (进程：OS 调度，轮流执行)
    +-----------------------------+

    +-----------------------------+
    | T1 | T2 | T3 | T1 | T2 | T3 |   (线程：OS 调度，轮流执行)
    +-----------------------------+

    +-----------------------------+
    | C1→C2→C3→C1→C2→C3→...       |   (协程：用户态切换，看似同时)
    +-----------------------------+
    ```
- 单核时，进程、线程 都是通过 时间片轮换 实现的并发
- 协程只是进一步把时间片的切换控制权交给程序员/运行时

>多核 CPU
- 假设 CPU 有 4 个核心
    ```diff
    核心1: | P1:T1 | P1:T2 | ... |
    核心2: | P2:T1 |        ... |
    核心3: | P3:T1 | P3:T2 | ... |
    核心4: | P4:T1 |        ... |
    ```
- 进程：不同核心可以同时运行不同进程
- 线程：一个进程的多个线程也可分布到不同核心
- 协程：如果只在单线程内运行，就只会占用一个核心；若多个线程各自运行协程，才可分布在多个核心上

### 3 总结

| 特性     | 单核 CPU        | 多核 CPU            |
| ------ | ------------- | ----------------- |
| **进程** | 轮流执行，不能并行     | 真并行（多个进程同时跑在不同核上） |
| **线程** | 轮流执行，不能并行     | 真并行（线程可分配到不同核）    |
| **协程** | 用户态并发，实为单线程切换 | 需要配合多线程/多进程才可利用多核 |
