# 09 常见误区与排障

## 常见误区

1. 以为 `async def` 自动并发。
2. 创建任务但从不 `await` 或回收。
3. 没有限流，瞬间创建海量任务。
4. 遇到超时后不取消底层任务。
5. 在协程里直接做 CPU 重活。
6. 忽略 `CancelledError`，导致退出不干净。

## 排障清单

1. 看是否有“长时间无 await”的代码段。
2. 打印 `asyncio.all_tasks()` 排查悬挂任务。
3. 给外部 I/O 全部加超时。
4. 对共享状态先加锁后优化。
5. 打开调试：

```python
import asyncio
asyncio.get_running_loop().set_debug(True)
```

## 诊断指标建议

- 任务总数、活跃任务数
- 成功率、超时率、取消率
- 队列长度
- P50/P95/P99 延迟
