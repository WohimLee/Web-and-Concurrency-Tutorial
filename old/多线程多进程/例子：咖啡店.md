## 一个例子

我们开了一家“协程咖啡馆”，你是老板，电脑是店铺，CPU 就是咖啡师的手
每天有顾客来点单（请求），要经历以下流程：
- 点单（接收请求）
- 磨豆（CPU 密集型）
- 冲咖啡（等待 I/O，比如烧水、加热、出咖啡）
- 上咖啡（返回结果）

#### 第一幕：同步咖啡馆（单线程同步）

- 只有一个咖啡师，做完一杯再做下一杯 
- 👉 问题：顾客太多，等待太久。每个 `I/O 阻塞` 时 CPU 都在闲着
```sh
开始做 拿铁
(等2秒)
拿铁 完成
开始做 美式
(等2秒)
美式 完成
...
```

#### 第二幕：多线程咖啡馆（线程池）

- 请来几位咖啡师（多线程），并行冲几杯
- 👉 多线程让多个人同时工作，适合“冲咖啡这种等待型操作（I/O 密集）”
- 但问题是：线程太多会有上下文切换开销，还会有 GIL 限制 CPU 并行
```
开始做 拿铁
开始做 美式
开始做 卡布奇诺
(等2秒)
三杯完成，再做剩下两杯...
```

#### 第三幕：多进程咖啡馆（进程池）

- 每个咖啡师带一套独立工具（内存空间），可以同时磨豆，适合 CPU 密集任务
- 👉 多进程打破 GIL 限制，真正多核并行
- 但每个进程内存独立，沟通成本高，启动慢

#### 第四幕：异步咖啡馆（async / await）
- 现在我们用一个超级高效的咖啡师，他可以“一边烧水，一边磨豆，一边接单”——
只要是在等待 I/O，就去干别的事。这就是协程的威力。

```
开始做 拿铁
开始做 美式
开始做 卡布奇诺
(等2秒)
三杯同时完成！
```

#### 第五幕：突然有同步老机器怎么办？（asyncio.to_thread）

- 你店里还有个老式磨豆机，只能同步调用 grind_beans()，会卡住事件循环。
怎么办？用 `asyncio.to_thread()` 把它交给后台线程执行
- 👉 `asyncio.to_thread()` 就像临时叫了个帮手在后厨干同步活，不耽误主咖啡师继续跑异步任务。

```
准备做 拿铁
准备做 美式
准备做 卡布奇诺
磨豆中 拿铁
磨豆中 美式
磨豆中 卡布奇诺
... 2秒后 ...
拿铁 的豆磨好了
拿铁 完成
美式 的豆磨好了
美式 完成
...
```

#### 第六幕：混合现实（真实 Web 应用）

现实世界（比如 FastAPI 服务）里，一个请求可能需要：

- 访问数据库（I/O 密集）
- 调用外部接口（I/O 密集）
- 做 embedding 或 LLM 推理（CPU 密集）

于是我们的“咖啡馆架构”变成：
```sh
┌────────────────────────────────────┐
│ FastAPI 异步服务（async/await）    │
│  ├─ 异步数据库查询 (await)         │
│  ├─ 调用API (await)                │
│  ├─ CPU重任务 → run_in_executor()  │
│  ├─ 同步库 → asyncio.to_thread()   │
│  └─ 整合结果返回                   │
└────────────────────────────────────┘
```
#### 总结
| 类型            | 特点         | 典型操作                        | 建议方案                                   |
| ------------- | ---------- | --------------------------- | -------------------------------------- |
| **I/O 密集异步库** | 本身支持 async | httpx.AsyncClient / asyncpg | 直接 `await`                             |
| **I/O 密集同步库** | 阻塞线程       | requests / 文件操作             | `await asyncio.to_thread()`            |
| **CPU 密集计算**  | 占满 GIL     | 向量化 / 解码 / 生成               | `run_in_executor(ProcessPoolExecutor)` |


| 概念                      | 类比          | 作用          | 适合任务    |
| ----------------------- | ----------- | ----------- | ------- |
| **进程**                  | 不同厨房        | 真并行、互不干扰    | CPU密集   |
| **线程**                  | 同厨房多咖啡师     | 并发I/O、多任务切换 | I/O密集   |
| **协程**                  | 超级咖啡师       | 事件循环切换I/O任务 | 大量异步I/O |
| **async/await**         | “等水烧开时先干别的” | 写出非阻塞代码     | 异步I/O并发 |
| **asyncio.to_thread**   | “临时叫个同步帮手”  | 在线程跑阻塞代码    | 同步阻塞I/O |
| **ProcessPoolExecutor** | “多厨房并行磨豆”   | 多核CPU并行     | 计算密集型   |
