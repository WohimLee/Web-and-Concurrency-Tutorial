# Flask

## 1 路由和请求方法
### 1.1 代码
```py
from flask import Flask, request  # 需要 import request 处理 POST 方法

app = Flask(__name__)

@app.route('/')
def home():
    return "Hello, Flask!"

@app.route('/user/<name>')
def user(name):
    return f"Hello, {name}!"

@app.route('/post/<int:post_id>')
def show_post(post_id):
    return f"Post ID: {post_id}"

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        return "Processing login..."
    return "Show login form"

if __name__ == '__main__':
    app.run(debug=False)  # True 启用 debug 模式，方便开发调试

```
- `<name>`：动态 URL 参数，`/user/Jack` 返回 "Hello, Jack!"
- `<int:post_id>`：指定数据类型为 `int`，`/post/5` 返回 "Post ID: 5"
- `methods=['GET', 'POST']`：指定允许的 HTTP 方法。

### 1.2 运行测试

打开浏览器，或者使用 `Postman` / `curl` 测试以下地址：

>访问 `/user/<name>` 路由
- 访问 http://127.0.0.1:5000/user/Jack
页面应返回：
    ```
    Hello, Jack!
    ```

>访问 `/post/<int:post_id>` 路由
- 访问 http://127.0.0.1:5000/post/123
页面应返回：
    ```yaml
    Post ID: 123
    ```

>访问 /login 路由
- 通过浏览器访问 http://127.0.0.1:5000/login，页面应返回：
    ```pgsql
    Show login form
    ```
    发送 POST 请求（使用 Postman 或 curl）：
    ```
    curl -X POST http://127.0.0.1:5000/login
    ```
    服务器应返回：
    ```nginx
    Processing login...
    ```


## 2 请求和响应
>`server.py`
```py

from flask import Flask, request  # 需要 import request 处理 POST 方法

app = Flask(__name__)

@app.route('/')
def home():
    return "Hello, Flask!"

@app.route("/milvus", methods=["POST"])
def search_recipe():
    # 从请求中获取 JSON 数据, 收到的 request 内容
    data = request.json

    # 从 JSON 数据中提取 "query" 字段的值，如果不存在则默认为空字符串
    query_text = data.get("prompt", "") 
    other = data.get("other", "")
    # 检查 query_text 是否为空
    if not query_text:
        return {"message": "Query text is required"}

    result = f"process results for {query_text}"
    return {"result": result}

if __name__ == '__main__':
    app.run(host="127.0.0.1", port=18888, debug=False) # True 启用 debug 模式，方便开发调试
```
- `request.json`：获取请求中的 JSON 数据（需 Content-Type: application/json）。
- `return {"result": result}`：Flask 会自动将字典转换为 JSON 响应。

>`client.py`
- 使用 Gradio 页面
```py
import time
import requests
import gradio as gr

def answer(prompt):

    query_data = {
        "prompt": prompt,
        "other": "其它信息"
    }
    response = requests.post(
        "http://127.0.0.1:18888/milvus",
        json=query_data,
        headers={"Content-Type":"application/json"}
    )

    if response.status_code == 200:
        response = response.json()
        result = response["result"]

    accumulated_result = ""  # 存储累积的输出
    for char in result:  # 逐字符输出
        accumulated_result += char  # 追加字符
        yield accumulated_result  # 发送累积的结果
        time.sleep(0.2)  # 模拟流式生成的延迟

if __name__ == "__main__":
    iface = gr.Interface(
        fn=answer,
        inputs=gr.Textbox(),
        outputs=gr.Markdown()
    )
    iface.launch()
```